
    <style>
        .parent {
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: row;
    		flex-wrap: wrap;
        }

        .card {
            background-color: #ffffff;
            height: 150px;
            width: 350px;
            margin: 10px;
            box-shadow: 0 5px 15px rgba(5, 0, 0, 0.1);
            padding: 10px 20px;
        }

        .card:hover{
            box-shadow: 0 5px 50px rgba(5, 0, 0, 0.1);
        }

        .heading {
            font-weight: bold;
            font-size: 14px;
            color: black;
            margin-top: 5px;
        }
        .heading a{
        	color: black;
        }

        .desc {
            color: black;
            font-size: 14px;
		    height: 21px;
		    text-overflow: ellipsis;
		    white-space: nowrap;
		    overflow: hidden;
        }

        .info {
            font-family: Arial, Helvetica, sans-serif;
        }

        .bottom {
            display: flex;
            justify-content: space-between;
        }
       
        .edit-btn:hover{
			color:blue  ;
			cursor: pointer;
		}
       
		.delete-btn:hover{
			color: red;
			cursor: pointer;
		}
        .bottom-left {
            padding-top: 3px;
            font-size: 14px;
        }
        .bottom-id{
            background: #1d7ff0;
            color: white;
            border-radius: 10px;
            padding: 5px 10px;
        }

        .title {
            font-size: 22px;
            display: flex;
            justify-content: center;
        }

        .title-left {
            width: 372px;
            padding-top: 4px;
        }

        .title-right {
            width: 28px;
            text-align: center;
            padding-top: 4px;
            font-size: 26px !important;
            color: #5983F1;
        }
        .corner-id{
		    position: absolute;
		    top: 0;
		    right: 0;
		    background-color: green;
		    border-bottom-left-radius: 30px;
		    width: 48px;
		    height: 35px;
		    color: white;
		    font-weight: bold;
		    padding: 4px;
		    text-align: center;
		    border: 1px solid green;
		}
		.title-anchor{
			cursor: pointer;
		}
		.ajs-dialog{
			min-height: 400px !important
		}
    </style>

     <!-- card -->
    <div class="">
        <div class="title">
            <span class="title-left text-center">Task Management</span>
            <!-- <a id="modalBtn" class="title-right" data-toggle="modal" data-target="#myModal"><i class="fa fa-plus-square"
                    aria-hidden="true"></i></a> -->
        </div>
        <div class="parent">
		 <!-- <div class="card ${task.id}">
				<span class="corner-id">#1</span>
		        <div class="info">
		            <div class="form-check mb-3">
						<input type="hidden" class="form-control task-id" value="">
		                <input class="form-check-input position-static task-status" type="checkbox" id="blankCheckbox" value="option" aria-label="...">
		                <span class="text-muted small">It's done?</span>
		            </div>
		            <h6 class="heading task-title"><a href="#" class="title-anchor"> Sample Task </a></h6>
		            <p class="desc task-description">Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum
                        has been</p>
		            <div class="bottom text-muted">
		                <span class="bottom-left text-muted task-dueDate"><b>Planting date: </b>5 July, 2023</span>
		                <div class="bottom-right">
		            		<a onclick='editTask("+JSON.stringify(task)+")' class='edit-btn fa-regular fa-pen-to-square'></a>&nbsp;&nbsp;<a  onclick='deleteTask("+ task.id +")'class='delete-btn fa-solid fa-trash-can'>&#xe020;</a>
		           	 	</div>
		            </div>
		        </div> -->
		    </div>
        </div>
    </div>
    <!-- Modal -->
    <!-- Modal -->
    <div id="myModal" class="modal fade" role="dialog" data-backdrop="static">
        <div class="modal-dialog">
    
        <!-- Modal content-->

        <div class="modal-content">
            <div class="modal-header">
				 <h4 class="modal-title" id="Modaltitle">Update Task</h4>
                <button type="button" id="modalCloseBtn" class="close" data-dismiss="modal">&times;</button>
               
            </div>
            <div class="modal-body">
                <form class="form-horizontal" id="taskForm">
                	<input type="hidden" class="form-control" id="taskId" >
                    <div class="form-group row">
                        <label class="control-label col-sm-4" for="cropId">Crop ID</label>
                            <div class="col-sm-8">
								<input type="text" class="form-control" readonly id="cropId">
                            </div>         
                    </div>
                    <div class="form-group row">
                        <label class="control-label col-sm-4" for="name">Title</label>
                            <div class="col-sm-8">
								<input type="text" class="form-control" id="name">
                            </div>         
                    </div>
                    <div class="form-group row">
                        <label class="control-label col-sm-4" for="description">Description :</label>
                            <div class="col-sm-8">
								<textarea class="form-control" id="description" rows="2" maxlength="255"></textarea>
								<div id="cropInfo"></div>
                            </div>         
                    </div>
		            <div class="form-group row">
		                <label for="yieldEstimation" class="control-label col-sm-4">Yield Estimation</label>
		                <div class="col-sm-8">
		                	<input type="number" class="form-control" id="yieldEstimation">
		                </div>
		            </div>
                    <div class="form-group row">
                        <label class="control-label col-sm-4" for="dueDate">Planting Date :</label>
                            <div class="col-sm-8">
                                <input type="date" class="form-control" id="dueDate"  >
                            </div> 
                    </div>
                    <div class="form-group row">
                        <label class="control-label col-sm-4" for="collectionDate">Collection Date :</label>
                            <div class="col-sm-8">
                                <input type="date" class="form-control" id="collectionDate"  >
                            </div> 
                    </div>
                    <div class="form-group row">
                        <label class="control-label col-sm-4" for="soilType">Soil Type</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control" readonly id="soilType"> 
                        </div>
                    </div>
					<div class="form-group row">
				        <label class="control-label col-sm-4" for="climateType">Climate Type</label>
				        <div class="col-sm-8">
				            <select class="form-control" id="climateType">
				                <option value="">Select</option>
				                <option value="Tropical">Tropical</option>
				                <option value="Dry">Dry</option>
				                <option value="Temperate">Temperate</option>
				                <option value="Continental">Continental</option>
				                <option value="Polar">Polar</option>
				                <option value="Highland">Highland</option>
				            </select>
				        </div>
				    </div>
          	<!-- 	<div class="form-group">
					      <div class="col-sm-8 custom-control custom-checkbox mr-sm-2">
					        <input type="checkbox" class="custom-control-input" id="taskStatus">
					        <label class="custom-control-label" for="taskStatus">Task Status</label>
					     </div>
					 </div> -->

                </form>
            </div>
            <div class="modal-footer">
            	<button type="button" class="btn btn-primary" id="calcBtn">Calculate</button>
                <button type="button" class="btn btn-primary" id="addBtn">Save</button>
                <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    
        </div>
    </div>

    <script>
		
        $(document).ready(function () {
        	
			var dynamicCard = function(task){
				
				const dueDate = new Date(task.dueDate);
				const formattedDate = dueDate.toLocaleDateString('en-US', {
				  day: '2-digit',
				  month: 'short',
				  year: 'numeric'
				});
				var status = task.status === "1"? "checked disabled": "";
				
				const isPassed = isDatePassed(dueDate);
				var isDue = isPassed ? "text-danger": "text-muted";
				return `
				    <div class="card ${task.id}">
						<span class="corner-id">#${task.id}</span>
				        <div class="info">
				            <div class="form-check mb-3">
								<input type="hidden" class="form-control task-id" value="${task.id}">
				                <input class="form-check-input position-static task-status" type="checkbox" id="blankCheckbox" ${status} value="option" aria-label="...">
				                <span class="text-muted small">It's done?</span>
				            </div>
				            <input type="hidden" class="form-control h-task-title" value="${task.title}">
				            <h6 class="heading task-title"><a onclick='showSummary(${JSON.stringify(task)})' class="title-anchor"> ${task.title} </a></h6>
				            <input type="hidden" class="form-control h-task-description" value="${task.description}">
				            <p class="desc task-description">${task.description}</p>
				            <div class="bottom text-muted">
				            	<input type="hidden" class="form-control h-task-dueDate" value="${formattedDate}">
				                <span class="bottom-left task-dueDate ${isDue}"><b>Planting date: </b>${formattedDate}</span>`+
				    '            <div class="bottom-right">'+
				    "        		<a onclick='editTask("+JSON.stringify(task)+")' class='edit-btn fa-regular fa-pen-to-square'></a>&nbsp;&nbsp;<a  onclick='deleteTask("+ task.id +")'class='delete-btn fa-solid fa-trash-can'>&#xe020;</a>" +
				    '       	 </div>' +
				            `</div>
				        </div>
				    </div>
				`
			}
			
			
            $.ajax({
                url: root + "/taskByStatus/0",
                type: "GET",
                headers: {
					'Accept': 'application/json',
					'Content-Type': 'application/json',
	                "Authorization": 'Bearer ' + userDetails.accessToken
				},
                success: function (response) {
                    // console.log(response);
                    response.forEach(function (task) {
                        $(".parent").append(dynamicCard(task));
                    })
                },
                error: function (error) {
                    console.log(error);
                }
            });


            $(".parent").on("click", ".task-status", function (e) {
				e.preventDefault();
				e.stopPropagation();
				
				swal({
				  title: "Do you want to mark it done?",
				  icon: "warning",
				  buttons: true,
				})
				.then((yes) => {
				  if (yes) {
					var check = $(this);
					var id = $(this).prev().val();
		            $.ajax({
			            url: root + "/updateTaskStatus/"+id ,
			            type: 'PUT',
			            headers: {
								'Accept': 'application/json',
								'Content-Type': 'application/json',
				                "Authorization": 'Bearer ' + userDetails.accessToken
						},
			            success: function (task) {
							check.prop("disabled", true);
							
							var updatedCard = $(".parent").find("."+task.id);
                            updatedCard.remove();
                            
			                getAllTasksByStatus();
			            },
			            error: function (error) {
			                swal(error.responseText);
			            }
			        });	
				  }
				});
			});	
            
        	var crops = [];
        	function getCrops(){
	       		$.ajax({
	       		    url: root + "/crop",
	       		    type: "GET",
	       		    headers: {
	       				'Accept': 'application/json',
	       				'Content-Type': 'application/json',
	       		        "Authorization": 'Bearer ' + userDetails.accessToken
	       			},
	       		    success: function (response) {
	       		        console.log(response);
	       		        crops = response;
	       		    },
	       		    error: function (error) {
	       		        console.log(error);
	       		    }
	       		});
	       	}
	       	getCrops();
            
            $("#calcBtn").click(function () {
                const cropId = $("#cropId").val();
                const cropName = $("#name").val();
                const yieldValue = parseFloat($("#yieldEstimation").val());

                if (isNaN(yieldValue) || yieldValue <= 0) {
                    alert("Please enter a valid yield value (greater than 0).");
                    return;
                }
                
                function getCropDetailsById(cropId) {
                    const crop = crops.find(crop => crop.id == cropId);
                    return crop ? { timeToMaturity: crop.timeToMaturity, seedRequirements: crop.seedRequirements, pesticides: crop.pesticides } : null;
                }

                //let timeToMaturity, seedRequirements;
                const cropDetails = getCropDetailsById(cropId);
                
                if (cropDetails) {
                	const { timeToMaturity, seedRequirements, pesticides } = cropDetails;
                    //timeToMaturity = timeToMaturity;
                    //seedRequirements = seedRequirements;

                    console.log(`Time to Maturity: ${timeToMaturity}`);
                    console.log(`Seed Requirements: ${seedRequirements}`);
                    console.log(`Yield (in kg/hectare): ${yieldValue}`);

                    // Calculate total seeds
                    const seedRate = parseFloat(seedRequirements.split(" ")[0]);
                    const totalSeeds = yieldValue * seedRate;
                    console.log(`Total Seeds Required: ${totalSeeds.toFixed(2)} kg`);
                    
                    var description = $("#description").val();
                    
                    var estimation = `Time to Maturity: ${timeToMaturity} \nSeed Requirements: ${seedRequirements} \nYield (in kg/hectare): ${yieldValue} \nTotal Seeds Required: ${totalSeeds.toFixed(2)} kg \nPesticides used: ${pesticides}`;
                    if(description){
                    	$("#description").val(description+`\n\n`+estimation);
                    }else{
                    	$("#description").val(estimation);
                    }
                    
                    const cropInfoDiv = $("#cropInfo");
                    cropInfoDiv.empty(); // Clear previous information
                    cropInfoDiv.append(`<p class="m-0 small"><b>Time to Maturity:</b> ${timeToMaturity}</p>`);
                    cropInfoDiv.append(`<p class="m-0 small"><b>Seed Requirements:</b> ${seedRequirements}</p>`);
                    cropInfoDiv.append(`<p class="m-0 small"><b>Yield (in kg/hectare):</b> ${yieldValue}</p>`);
                    cropInfoDiv.append(`<p class="m-0 small"><b>Total Seeds Required:</b> ${totalSeeds.toFixed(2)} kg</p>`);
                    cropInfoDiv.append(`<p class="m-0 small"><b>Pesticides used:</b> ${pesticides}</p>`);
                } else {
                	cropInfoDiv.append(`<p><b>No information found for the crop "${cropName}".</b></p>`);
                }
            });
            
            $("#addBtn").click(function () {
                var data ={
                		"cropId": $("#cropId").val(),
                        "title": $("#name").val(),
                        "description": $("#description").val(),
                        "yield": $("#yieldEstimation").val(),
                        "dueDate": $("#dueDate").val(),
                        "collectionDate": $("#collectionDate").val(),
                        "soilType": $("#soilType").val(),
                        "climateType": $("#climateType").val(),
                        //"status": $("#taskStatus").is(":checked") ? "1":"0"    
                    }

                console.log(JSON.stringify(data));

                var url = root + "/task";
                var method = 'post';


                var id = $("#taskId").val();
                //console.log(id);
                if(id){
                    data.id = id;
                    url = root + "/task/"+id ;
                    method = 'put';
                }
                $.ajax({
                    url: url,
                    type: method,
                    data: JSON.stringify(data),
	                headers: {
						'Accept': 'application/json',
						'Content-Type': 'application/json',
		                "Authorization": 'Bearer ' + userDetails.accessToken
					},
                    success: function (task) {
                        //console.log(task);
                        if(id){
                            var updatedCard = $(".parent").find("."+task.id);
                            updatedCard.replaceWith(dynamicCard(task));
                            
                            alertify.success('Task updated successfully!');
                        }else{
                            $(".parent").append(dynamicCard(task));  
                            alertify.success('Task created successfully!');   
                        }
                        getAllTasksByStatus();
                        $("#taskForm")[0].reset();
                        $("#modalCloseBtn").trigger("click");
                     },
                    error: function (error) {
                        swal(error.responseText);
                    }
                });
                
            });



        });

        function editTask(task){
        	console.log(task);
        	$("#myModal").modal('show');
            
        	const cropInfoDiv = $("#cropInfo");
            cropInfoDiv.empty();
            $("#taskId").val(task.id);
            $("#cropId").val(task.cropId);
            $("#name").val(task.title);
            $("#description").val(task.description);
            $("#dueDate").val(task.dueDate);
            $("#collectionDate").val(task.collectionDate);
            $("#yieldEstimation").val(task.yield);
            $("#soilType").val(task.soilType);
            $("#climateType").val(task.climateType);
            $("#taskStatus").prop("checked", task.status === "1" ? true:false);
            $("#addBtn").text("Update");
        }

        $("#modalBtn").click(function () {$("#taskForm")[0].reset()});
        

        function deleteTask(id){
			swal({
			  title: "Are you sure?",
			  text: "Do you want to delete this task #"+id+"?",
			  icon: "warning",
			  buttons: true,
			  dangerMode: true,
			})
			.then((willDelete) => {
			  if (willDelete) {
	            $.ajax({
		            url: root + "/task/"+id ,
		            type: 'DELETE',
		            headers: {
							'Accept': 'application/json',
							'Content-Type': 'application/json',
			                "Authorization": 'Bearer ' + userDetails.accessToken
					},
		            success: function (result) {
		                getAllTasksByStatus();
		
		                var removeCard = $(".parent").find("."+id);
		                console.log(removeCard);
		                $(removeCard).remove();
		                
		                swal("Task has been deleted!", {
					      icon: "success",
					    });
		            },
		            error: function (error) {
		                swal(error.responseText);
		            }
		        });
			  }
			});
    }
    </script>